# ==============================================================================
# WORKFLOW: SonarCloud Analysis
# ==============================================================================
# Prop√≥sito: Analizar autom√°ticamente la calidad del c√≥digo con SonarCloud
#            en cada push o pull request a cualquier rama del repositorio.
#
# ¬øQu√© hace este workflow?
# 1. Se ejecuta cuando haces push o creas un pull request en cualquier rama
# 2. Clona el repositorio completo (historial incluido)
# 3. Configura el entorno Java necesario para SonarScanner
# 4. Usa cach√© para acelerar ejecuciones futuras
# 5. Ejecuta el an√°lisis de SonarCloud y env√≠a los resultados
# 6. Los resultados aparecen en: https://sonarcloud.io
#
# Requisitos previos:
# - Token generado en SonarCloud (My Account > Security > Generate Token)
# - Token guardado en GitHub (Settings > Secrets > Actions > SONAR_TOKEN)
# - Proyecto vinculado en SonarCloud con tu organizaci√≥n
# ==============================================================================

name: SonarCloud Analysis

# ==============================================================================
# EVENTOS QUE DISPARAN EL WORKFLOW
# ==============================================================================
# Este workflow se ejecuta autom√°ticamente en dos situaciones:
on:
  # 1. PUSH: Cuando subes cambios (commit + push) a cualquier rama
  push:
    branches:
      - '**'  # '**' significa "todas las ramas" (master, Gabo, wiki, etc.)
              # Si quieres limitar a ramas espec√≠ficas, usa:
              # - master
              # - main
              # - develop

  # 2. PULL REQUEST: Cuando creas o actualizas un PR hacia cualquier rama
  pull_request:
    branches:
      - '**'  # Analiza PRs que apunten a cualquier rama
              # Esto permite ver la calidad del c√≥digo ANTES de fusionar

# ==============================================================================
# JOBS: TAREAS QUE SE EJECUTAN
# ==============================================================================
jobs:
  # Job principal: an√°lisis de c√≥digo con SonarCloud
  sonarcloud-analysis:
    name: üîç An√°lisis de C√≥digo con SonarCloud
    runs-on: ubuntu-latest  # Ejecuta en un servidor Ubuntu (gratis en GitHub)

    steps:
      # ========================================================================
      # PASO 1: Clonar el repositorio completo
      # ========================================================================
      # Descarga todo el c√≥digo fuente del repositorio a la m√°quina virtual
      - name: üì• Checkout del repositorio
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 descarga TODO el historial de commits
          # ¬øPor qu√©? SonarCloud necesita el historial para:
          # - Detectar qu√© archivos cambiaron en el PR
          # - Calcular m√©tricas de c√≥digo nuevo vs c√≥digo existente
          # - Analizar la evoluci√≥n de la calidad del c√≥digo
          fetch-depth: 0

      # ========================================================================
      # PASO 2: Configurar Java (requerido por SonarScanner)
      # ========================================================================
      # SonarScanner necesita Java para ejecutarse (aunque tu proyecto sea Python)
      - name: ‚òï Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'  # Distribuci√≥n OpenJDK recomendada
          java-version: '17'       # Versi√≥n LTS (Long Term Support)

      # ========================================================================
      # PASO 3: Configurar cach√© de SonarCloud
      # ========================================================================
      # Guarda archivos temporales para que las pr√≥ximas ejecuciones sean m√°s r√°pidas
      - name: üíæ Cach√© de SonarCloud
        uses: actions/cache@v4
        with:
          # Ubicaci√≥n de archivos temporales de SonarCloud
          path: ~/.sonar/cache
          # Clave √∫nica para esta cach√© (si cambia el OS o archivos, se regenera)
          key: ${{ runner.os }}-sonar
          # Si no existe la clave exacta, usa esta como respaldo
          restore-keys: ${{ runner.os }}-sonar

      # ========================================================================
      # PASO 4: Ejecutar an√°lisis de SonarCloud
      # ========================================================================
      # Acci√≥n oficial de SonarSource que ejecuta el an√°lisis
      - name: üöÄ An√°lisis con SonarCloud
        uses: SonarSource/sonarcloud-github-action@master
        env:
          # SONAR_TOKEN: Token de autenticaci√≥n (guardado en GitHub Secrets)
          # ¬øC√≥mo obtenerlo?
          # 1. Ir a https://sonarcloud.io
          # 2. My Account > Security > Generate Token
          # 3. Copiar el token
          # 4. GitHub: Settings > Secrets and variables > Actions > New secret
          # 5. Name: SONAR_TOKEN, Value: <tu token>
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

          # GITHUB_TOKEN: Token autom√°tico de GitHub (no necesitas crearlo)
          # Permite a SonarCloud:
          # - Comentar en PRs con el resumen de an√°lisis
          # - Actualizar el estado del PR (‚úÖ passed / ‚ùå failed)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        # Configuraci√≥n del an√°lisis (argumentos para SonarScanner)
        with:
          args: >
            -Dsonar.projectKey=JEYomboy_FinalPoo2
            -Dsonar.organization=jeyomboy

      # ========================================================================
      # INFORMACI√ìN ADICIONAL (Opcional)
      # ========================================================================
      # Si el an√°lisis falla, puedes a√±adir este paso para ver m√°s detalles:
      #
      # - name: üìã Mostrar logs de an√°lisis
      #   if: failure()
      #   run: cat .scannerwork/report-task.txt

# ==============================================================================
# DOCUMENTACI√ìN: C√ìMO USAR ESTE WORKFLOW
# ==============================================================================
#
# 1. ¬øQU√â HACE ESTE WORKFLOW?
#    - Se ejecuta autom√°ticamente en cada push o pull request
#    - Analiza tu c√≥digo en busca de bugs, vulnerabilidades, code smells
#    - Mide cobertura de tests, duplicaci√≥n de c√≥digo, complejidad
#    - Env√≠a resultados a SonarCloud para visualizaci√≥n
#    - Comenta en PRs con el resumen de calidad (si est√° habilitado)
#
# 2. ¬øC√ìMO INTERPRETAR LOS RESULTADOS EN SONARCLOUD?
#    Abre tu proyecto en https://sonarcloud.io y ver√°s:
#
#    A) QUALITY GATE (Puerta de Calidad):
#       - ‚úÖ Passed: El c√≥digo cumple los est√°ndares m√≠nimos de calidad
#       - ‚ùå Failed: Hay problemas cr√≠ticos que deben corregirse
#
#    B) M√âTRICAS PRINCIPALES:
#       - Bugs: Errores que pueden causar fallos en producci√≥n
#       - Vulnerabilities: Problemas de seguridad (ej: SQL injection)
#       - Code Smells: C√≥digo que funciona pero es dif√≠cil de mantener
#       - Coverage: % de c√≥digo cubierto por tests
#       - Duplications: % de c√≥digo duplicado
#       - Security Hotspots: C√≥digo que requiere revisi√≥n de seguridad
#
#    C) PESTA√ëA "BRANCHES & PULL REQUESTS":
#       - Aqu√≠ ves el an√°lisis de cada rama (master, Gabo, wiki, etc.)
#       - Para PRs: ver√°s an√°lisis del c√≥digo nuevo (no todo el proyecto)
#       - Click en una rama para ver detalles e issues espec√≠ficos
#
#    D) PESTA√ëA "ISSUES":
#       - Lista todos los problemas encontrados
#       - Filtros: severidad, tipo, archivo, asignado a...
#       - Click en un issue para ver d√≥nde est√° y c√≥mo corregirlo
#
# 3. ¬øC√ìMO MODIFICAR EL WORKFLOW?
#
#    A) Analizar s√≥lo ciertas ramas:
#       on:
#         push:
#           branches:
#             - master      # S√≥lo rama master
#             - develop     # Y rama develop
#             - 'feature/*' # Y ramas que empiecen con "feature/"
#
#    B) Excluir archivos del an√°lisis:
#       A√±ade en el bloque "with: args:" de SonarCloud:
#         -Dsonar.exclusions=**/migrations/**,**/static/**,**/tests/**
#
#    C) A√±adir cobertura de tests:
#       Antes del paso de SonarCloud, a√±ade:
#         - name: Ejecutar tests con cobertura
#           run: |
#             pip install pytest pytest-cov
#             pytest --cov=. --cov-report=xml:coverage.xml
#       Y en los args de SonarCloud a√±ade:
#         -Dsonar.python.coverage.reportPaths=coverage.xml
#
#    D) Cambiar versi√≥n de Java (si es necesario):
#       En "Configurar Java 17", cambia:
#         java-version: '21'  # Para Java 21 (m√°s reciente)
#
# 4. SOLUCI√ìN DE PROBLEMAS COMUNES:
#
#    ‚ùå "SONAR_TOKEN not found":
#       - Verifica que creaste el secret en GitHub
#       - Settings > Secrets and variables > Actions > SONAR_TOKEN
#
#    ‚ùå "Project not found in SonarCloud":
#       - Verifica sonar.projectKey y sonar.organization
#       - Deben coincidir con tu proyecto en SonarCloud
#
#    ‚ùå "Shallow clone detected":
#       - Aseg√∫rate de tener fetch-depth: 0 en el checkout
#
#    ‚ùå El an√°lisis se ejecuta pero no veo resultados:
#       - Espera 1-2 minutos (el procesamiento toma tiempo)
#       - Revisa la pesta√±a "Background Tasks" en SonarCloud
#
# 5. RECURSOS ADICIONALES:
#    - Documentaci√≥n oficial: https://docs.sonarcloud.io
#    - GitHub Action: https://github.com/SonarSource/sonarcloud-github-action
#    - Configuraci√≥n avanzada: https://docs.sonarcloud.io/advanced-setup/analysis-parameters/
#
# ==============================================================================
